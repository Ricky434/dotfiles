Ho aggiunto il kernel parameter in /etc/modprobe.d/vfio.conf per dire a vfio quale scheda video prendere

Ho fatto un nuovo mikinitcpio.conf chiamato mkinitcpio-custom.conf, con il quale genero l'image initramfs-provavm.conf
Si rigenera automaticamente da solo perche ho aggiunto il profilo provavm in /etc/mkinitcpio.d/linux.preset

Ho aggiunto un coso per generare la entry in grub per l'image initramfs-provavm.img in /etc/grub.d/10_linux (inizia al commento ##### MIA ENTRY) 

Ho patchato il vbios della mia gpu e ho detto a kvm di usarlo

Per windows11 va aggiunto il modulo tpm e selezionato il bios uefi con secureboot

Attaccare la parte audio della gpu alla vm e' la causa dell'errore 127, posso semplicemente non attaccarla

Non so se serve disattivare la rom bar per la gpu, nel dubbio l'ho fatto

PER TUTTO QUESTO TEMPO MI DAVA BLACK SCREEN SOLO PERCHE SERVE UN SECONDO MONITOR A CUI ATTACCARE LA SCHEDA PASSTHROUGHATA

Uso Looking glass per non avere bisogno del secondo monitor (o secondo cavo hdmi) (archwiki)
Creo uno shared memory file al boot con la configurazione in /etc/tmpfiles.d/10-looking-glass.conf
Per far funzionare looking glass servono il virtio driver, gli spice guest tools e il looking-glass-host per windows
Prima di installare il looking-glass-host (DEVE ESSERE DELLA STESSA VERSIONE DI LOOKING GLASS PER LINUX) bisogna aggiornare il device PCI standard RAM Controller (in System Devices) tramite i drivers forniti sul sito di looking glass (da redhat)
Per far comparire quel device bisogna aggiungere il device looking-glass nel xml della vm
Per far funzionare looking glass bisogna attaccare un cavo hdmi alla scheda passthroughata

Per usare un singolo mouse e tastiera glieli passo come input evdev (archwiki) (IL TOGGLE E' left-CTRL+right-CTRL)

Per il poco che ho provato, Hyper-V crea solo enormi problemi, forse cambiando qualche parte dell'xml della vm lo si rende utile


Per shared folder: samba share: starta smb.service, collegati da windows a \\indirizzo-ip\nome-cartella (nome-cartella= [shared] in smb.conf), ricordati di aggiungere regola al firewall dell'host


Per il boot noPassthrough: se tutte e due le gpu sono collegate al monitor, l'ambiente grafico non parte, anche se i moduli nvidia sono caricati correttamente.
Se solo una delle due gpu e' collegata tutto funziona come dovrebbe.
Comunque se ho bootato con il passthrough e non sto usando la gpu, posso unbindarla da vfio-pci e bindarla a nvidia (per vedere la differenza in nvidia-settings devo riavviare l'ambiente grafico, ma se riavvio l'ambiente grafico, i comandi per unbindare/bindare non funzionano piu, e' come se andassero in loop)
E dopo aver fatto quello che volevo fare posso unbindarla da nvidia e ribindarla a vfio-pci
(per la parte audio della gpu invece di nvidia bisogna bindare/unbindare a snd_hda_intel)
Comandi utili: "lspci -nnk -d 10de:", "sudo dmesg"

Script per bindare a nvidia:

#!/bin/sh
#ID della gpu (video e audio)
ID1="0000:29:00.0"
ID2="0000:29:00.1"
echo "Unbind GPU from vfio driver"
sudo sh -c "echo -n $ID1 > /sys/bus/pci/drivers/vfio-pci/unbind" || echo "Failed to unbind $ID1"
sudo sh -c "echo -n $ID2 > /sys/bus/pci/drivers/vfio-pci/unbind" || echo "Failed to unbind $ID2"
echo "Bind GPU to nvidia driver"
sudo sh -c "echo -n $ID1 > /sys/bus/pci/drivers/nvidia/bind" || echo "Failed to bind $ID1"
echo "Bind GPU audio to snd_hda_intel driver"
sudo sh -c "echo -n $ID2 > /sys/bus/pci/drivers/snd_hda_intel/bind" || echo "Failed to bind $ID2"

Inverti bind/unbind per bindare a vfio
